<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blockplain DeFi Simulator</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .panel {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      flex: 1;
      min-width: 300px;
    }
    h1 {
      color: #2c3e50;
      margin-top: 0;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #34495e;
    }
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background: #3498db;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
      flex: 1;
      min-width: 120px;
    }
    button:hover {
      background: #2980b9;
    }
    button#deposit {
      background: #2ecc71;
    }
    button#deposit:hover {
      background: #27ae60;
    }
    button#stake {
      background: #9b59b6;
    }
    button#stake:hover {
      background: #8e44ad;
    }
    button#withdraw {
      background: #e67e22;
    }
    button#withdraw:hover {
      background: #d35400;
    }
    #userInfo {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    #log {
      height: 200px;
      overflow-y: auto;
      background: #1a1a1a;
      color: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
    }
    .log-entry {
      margin-bottom: 5px;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }
    .blockplain-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 5px;
      margin-top: 20px;
    }
    .block {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 3px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 8px;
      font-weight: bold;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s;
      cursor: pointer;
    }
    .block:hover {
      transform: scale(1.1);
      z-index: 10;
    }
    .block-address {
      font-size: 6px;
      margin-bottom: 2px;
      background: rgba(0,0,0,0.3);
      padding: 1px 3px;
      border-radius: 2px;
    }
    .block-type {
      font-size: 8px;
      text-transform: capitalize;
    }
    .block-value {
      font-size: 7px;
      margin-top: 2px;
    }
    .balance-block {
      background: #2ecc71;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }
    .staked-block {
      background: #9b59b6;
      background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    }
    .yield-block {
      background: #e67e22;
      background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
    }
    .empty-block {
      background: #ecf0f1;
      border: 1px dashed #bdc3c7;
      color: #7f8c8d;
    }
    .section-title {
      font-size: 18px;
      margin: 15px 0 10px 0;
      color: #2c3e50;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }
    .flex-container {
      display: flex;
      gap: 20px;
      width: 100%;
    }
    .block-details {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      font-size: 14px;
    }
    .hex-code {
      font-family: monospace;
      word-break: break-all;
      background: #1a1a1a;
      color: #f0f0f0;
      padding: 5px;
      border-radius: 3px;
      margin-top: 5px;
      font-size: 12px;
    }
    .transaction {
      margin-top: 5px;
      padding: 3px;
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
      font-size: 12px;
    }
    @media (max-width: 768px) {
      .flex-container {
        flex-direction: column;
      }
      .blockplain-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="panel" style="flex: 2;">
    <h1>üöÄ Blockplain DeFi Simulator</h1>
    
    <div class="input-group">
      <label for="userId">User ID</label>
      <input type="text" id="userId" placeholder="e.g. user123" value="user1">
    </div>
    
    <div class="input-group">
      <label for="amount">Amount</label>
      <input type="number" id="amount" placeholder="e.g. 100" value="50">
    </div>
    
    <div class="button-group">
      <button id="deposit" onclick="performAction('deposit')">Deposit</button>
      <button id="stake" onclick="performAction('stake')">Stake</button>
      <button id="withdraw" onclick="performAction('withdraw')">Withdraw Yield</button>
      <button onclick="getUser()">üîÑ Refresh</button>
    </div>
    
    <div class="section-title">üìä User Information</div>
    <div id="userInfo">
      <p>No data loaded yet. Click "Refresh" to see your status.</p>
    </div>
    
    <div class="section-title">üñ•Ô∏è Blockplain Visualization (10x10 Grid)</div>
    <div id="blockplain" class="blockplain-grid">
      <div class="empty-block">Empty Blockplain</div>
    </div>
    
    <div class="block-details">
      <div class="section-title">üîç Block Details</div>
      <div id="blockDetails">Click on a block to view details</div>
    </div>
  </div>
  
  <div class="panel">
    <div class="section-title">üìú Activity Log</div>
    <div id="log"></div>
    
    <div class="section-title" style="margin-top: 20px;">‚ÑπÔ∏è Blockplain Legend</div>
    <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
      <div style="display: flex; align-items: center;">
        <div class="block balance-block" style="margin-right: 5px; width: 20px; height: 20px;"></div>
        <span>Balance (Green) - Deposited funds</span>
      </div>
      <div style="display: flex; align-items: center;">
        <div class="block staked-block" style="margin-right: 5px; width: 20px; height: 20px;"></div>
        <span>Staked (Purple) - Funds earning yield</span>
      </div>
      <div style="display: flex; align-items: center;">
        <div class="block yield-block" style="margin-right: 5px; width: 20px; height: 20px;"></div>
        <span>Yield (Orange) - Generated rewards</span>
      </div>
    </div>
    
    <div class="section-title" style="margin-top: 20px;">üìà Yield Simulation</div>
    <div style="margin-top: 10px;">
      <p>Yield is automatically generated at 0.1% per hour on staked amounts.</p>
      <button onclick="simulateYield()">‚è© Simulate 1 Day Yield</button>
      <button onclick="simulateWeek()">‚è©‚è© Simulate 1 Week</button>
    </div>
  </div>

  <script>
    // User data storage - Simulating the Go backend
    const users = {};
    let currentUserId = 'user1';
    const BLOCK_SIZE = 10; // Each block represents 10 units
    const YIELD_RATE = 0.001; // 0.1% per hour
    
    // Initialize default user if not exists
    function initUser(id) {
      if (!users[id]) {
        users[id] = {
          id: id,
          balance: 0,
          staked: 0,
          yield: 0,
          lastUpdate: Date.now(),
          blocks: [], // Stores all blocks owned by this user
          transactions: [] // Transaction history
        };
        addLog(`Created new user: ${id}`);
        addTransaction(id, 'user_creation', 0, 'User account created');
      }
      currentUserId = id;
      return users[id];
    }
    
    // Add transaction to history
    function addTransaction(userId, txType, amount, description) {
      const user = users[userId];
      if (user) {
        user.transactions.push({
          type: txType,
          amount: amount,
          timestamp: Date.now(),
          description: description
        });
      }
    }
    
    // Generate a random hex address (simulating blockchain address)
    function generateHexAddress(x, y) {
      const prefix = '0x';
      const coords = `${x.toString(16).padStart(4,'0')}${y.toString(16).padStart(4,'0')}`;
      const randomHash = Array.from({length: 8}, () => 
        Math.floor(Math.random() * 16).toString(16)).join('');
      return prefix + coords + randomHash;
    }
    
    // Create a new block in the Blockplain
    function createBlock(type, amount, user) {
      // Find first available position in 10x10 grid
      for (let y = 1; y <= 10; y++) {
        for (let x = 1; x <= 10; x++) {
          const existingBlock = user.blocks.find(b => b.x === x && b.y === y);
          if (!existingBlock) {
            const block = {
              x,
              y,
              type,
              amount,
              address: generateHexAddress(x, y),
              timestamp: Date.now(),
              transactions: []
            };
            user.blocks.push(block);
            
            // Add creation transaction
            block.transactions.push({
              type: 'block_creation',
              amount: amount,
              timestamp: Date.now(),
              description: `${type} block created at [${x}][${y}]`
            });
            
            addLog(`Created ${type} block at [${x}][${y}] with ${amount} tokens`);
            return block;
          }
        }
      }
      addLog('Warning: Blockplain grid is full!');
      return null; // Grid is full
    }
    
    // Calculate yield since last update (simulating Go backend logic)
    function calculateYield(user) {
      const now = Date.now();
      const hoursPassed = (now - user.lastUpdate) / (1000 * 60 * 60);
      const yieldGenerated = user.staked * YIELD_RATE * hoursPassed;
      
      if (yieldGenerated > 0) {
        user.yield += yieldGenerated;
        addTransaction(user.id, 'yield_generation', yieldGenerated, 
          `Generated ${yieldGenerated.toFixed(4)} yield from staking`);
        
        // Create yield blocks if significant amount
        if (yieldGenerated >= BLOCK_SIZE) {
          const blocksToCreate = Math.floor(yieldGenerated / BLOCK_SIZE);
          for (let i = 0; i < blocksToCreate; i++) {
            createBlock('yield', BLOCK_SIZE, user);
          }
        }
        addLog(`Generated yield: ${yieldGenerated.toFixed(4)} for ${user.id}`);
      }
      
      user.lastUpdate = now;
    }
    
    // Display user information
    function displayUser(user) {
      calculateYield(user);
      
      document.getElementById('userInfo').innerHTML = `
        <p><strong>ID:</strong> ${user.id}</p>
        <p><strong>Balance:</strong> ${user.balance.toFixed(2)}</p>
        <p><strong>Staked:</strong> ${user.staked.toFixed(2)}</p>
        <p><strong>Yield:</strong> ${user.yield.toFixed(4)}</p>
        <p><strong>Total Value:</strong> ${(user.balance + user.staked + user.yield).toFixed(2)}</p>
        <p><strong>Blocks Owned:</strong> ${user.blocks.length}/100</p>
      `;
      
      renderBlockplain(user);
    }
    
    // Render the Blockplain visualization
    function renderBlockplain(user) {
      const blockplain = document.getElementById('blockplain');
      blockplain.innerHTML = '';
      
      // Create 10x10 grid
      for (let y = 1; y <= 10; y++) {
        for (let x = 1; x <= 10; x++) {
          const blockElement = document.createElement('div');
          const existingBlock = user.blocks.find(b => b.x === x && b.y === y);
          
          if (existingBlock) {
            blockElement.className = `block ${existingBlock.type}-block`;
            blockElement.innerHTML = `
              <div class="block-address">[${x}][${y}]</div>
              <div class="block-type">${existingBlock.type}</div>
              <div class="block-value">${existingBlock.amount.toFixed(2)}</div>
            `;
            blockElement.onclick = () => showBlockDetails(existingBlock, user);
          } else {
            blockElement.className = 'block empty-block';
            blockElement.innerHTML = `
              <div class="block-address">[${x}][${y}]</div>
              <div>empty</div>
            `;
          }
          
          blockplain.appendChild(blockElement);
        }
      }
    }
    
    // Show block details
    function showBlockDetails(block, user) {
      let transactionsHtml = '';
      if (block.transactions && block.transactions.length > 0) {
        transactionsHtml = '<div class="section-title" style="font-size:14px;margin:10px 0 5px 0;">Block Transactions</div>';
        block.transactions.forEach(tx => {
          transactionsHtml += `
            <div class="transaction">
              <strong>${tx.type.replace(/_/g, ' ')}</strong><br>
              ${tx.description}<br>
              <small>${new Date(tx.timestamp).toLocaleString()}</small>
            </div>
          `;
        });
      }
      
      document.getElementById('blockDetails').innerHTML = `
        <p><strong>Type:</strong> ${block.type}</p>
        <p><strong>Amount:</strong> ${block.amount.toFixed(2)}</p>
        <p><strong>Coordinates:</strong> [${block.x}][${block.y}]</p>
        <p><strong>Created:</strong> ${new Date(block.timestamp).toLocaleString()}</p>
        <p><strong>Hex Address:</strong></p>
        <div class="hex-code">${block.address}</div>
        ${transactionsHtml}
      `;
    }
    
    // Add entry to log
    function addLog(message) {
      const log = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }
    
    // Perform actions (simulating Go backend endpoints)
    function performAction(action) {
      const id = document.getElementById('userId').value || 'user1';
      const amount = parseFloat(document.getElementById('amount').value) || 0;
      const user = initUser(id);
      
      calculateYield(user);
      
      switch(action) {
        case 'deposit':
          if (amount <= 0) {
            addLog('Error: Deposit amount must be positive');
            return;
          }
          user.balance += amount;
          addTransaction(id, 'deposit', amount, `Deposit of ${amount} tokens`);
          
          // Create blocks for the deposited amount
          const depositBlocks = Math.floor(amount / BLOCK_SIZE);
          for (let i = 0; i < depositBlocks; i++) {
            createBlock('balance', BLOCK_SIZE, user);
          }
          
          addLog(`Deposited ${amount.toFixed(2)} to ${id} (created ${depositBlocks} blocks)`);
          break;
          
        case 'stake':
          if (amount <= 0) {
            addLog('Error: Stake amount must be positive');
            return;
          }
          if (amount > user.balance) {
            addLog(`Error: Insufficient balance (${user.balance.toFixed(2)}) to stake ${amount.toFixed(2)}`);
            return;
          }
          user.balance -= amount;
          user.staked += amount;
          addTransaction(id, 'stake', amount, `Staked ${amount} tokens`);
          
          // Create blocks for the staked amount
          const stakeBlocks = Math.floor(amount / BLOCK_SIZE);
          for (let i = 0; i < stakeBlocks; i++) {
            createBlock('staked', BLOCK_SIZE, user);
          }
          
          addLog(`Staked ${amount.toFixed(2)} from ${id} (created ${stakeBlocks} blocks)`);
          break;
          
        case 'withdraw':
          if (user.yield <= 0) {
            addLog('Error: No yield to withdraw');
            return;
          }
          const yieldAmount = user.yield;
          user.balance += yieldAmount;
          addTransaction(id, 'withdraw', yieldAmount, `Withdrew ${yieldAmount.toFixed(4)} yield`);
          user.yield = 0;
          
          // Remove yield blocks
          const yieldBlocks = user.blocks.filter(b => b.type === 'yield');
          user.blocks = user.blocks.filter(b => b.type !== 'yield');
          
          addLog(`Withdrew yield ${yieldAmount.toFixed(4)} to ${id}'s balance (removed ${yieldBlocks.length} yield blocks)`);
          break;
      }
      
      displayUser(user);
    }
    
    // Get user data (simulating /user endpoint)
    function getUser() {
      const id = document.getElementById('userId').value || 'user1';
      const user = initUser(id);
      addLog(`Refreshed data for ${id}`);
      displayUser(user);
    }
    
    // Simulate yield generation
    function simulateYield() {
      const id = document.getElementById('userId').value || 'user1';
      const user = initUser(id);
      
      // Simulate 1 day passing (24 hours)
      user.lastUpdate -= 24 * 60 * 60 * 1000;
      calculateYield(user);
      
      addLog(`Simulated 1 day of yield generation for ${id}`);
      displayUser(user);
    }
    
    // Simulate a week of yield
    function simulateWeek() {
      const id = document.getElementById('userId').value || 'user1';
      const user = initUser(id);
      
      // Simulate 7 days passing (168 hours)
      user.lastUpdate -= 7 * 24 * 60 * 60 * 1000;
      calculateYield(user);
      
      addLog(`Simulated 1 week of yield generation for ${id}`);
      displayUser(user);
    }
    
    // Initialize with default user
    window.onload = function() {
      initUser('user1');
      // Start with some initial balance
      users['user1'].balance = 100;
      createBlock('balance', 100, users['user1']);
      addTransaction('user1', 'initial_funds', 100, 'Initial account funding');
      
      getUser();
      addLog('Blockplain DeFi Simulator initialized');
      addLog('Mirroring Go backend behavior with 2D Blockplain visualization');
    };
  </script>
</body>
</html>